name: Sync Strategies to RL Training

on:
  workflow_run:
    workflows: ["Run Tests"]
    types:
      - completed
    branches:
      - main

jobs:
  check-strategy-changes:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      strategies_changed: ${{ steps.check.outputs.strategies_changed }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: Check for strategy changes
      id: check
      run: |
        # Get the list of changed files in the last commit
        CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
        echo "Changed files:"
        echo "$CHANGED_FILES"
        
        # Check if any files in strategies/ folder changed
        if echo "$CHANGED_FILES" | grep -q "^strategies/"; then
          echo "strategies_changed=true" >> $GITHUB_OUTPUT
          echo "Strategy files changed - will proceed with sync"
        else
          echo "strategies_changed=false" >> $GITHUB_OUTPUT
          echo "No strategy files changed - skipping sync"
        fi
  
  sync:
    runs-on: ubuntu-latest
    needs: check-strategy-changes
    if: needs.check-strategy-changes.outputs.strategies_changed == 'true'
    
    steps:
    - name: Checkout algorithm-POC repository
      uses: actions/checkout@v4
      with:
        path: algorithm-poc
    
    - name: Checkout rl-training repository
      uses: actions/checkout@v4
      with:
        repository: AlgoTrading-Capstone/rl-training
        token: ${{ secrets.RL_TRAINING_PAT }}
        path: rl-training
    
    - name: Sync strategies folder
      run: |
        # Define files that should be preserved (not deleted during sync)
        PRESERVE_FILES="registry.py"
        
        # Create strategies directory in rl-training if it doesn't exist
        mkdir -p rl-training/strategies
        
        # Create temporary backup directory for preserved files
        TEMP_BACKUP=$(mktemp -d)
        
        # Backup files that should be preserved
        cd rl-training/strategies
        echo "$PRESERVE_FILES" | tr ' ' '\n' | while read -r file; do
          if [ -f "$file" ]; then
            echo "Backing up preserved file: $file"
            cp "$file" "$TEMP_BACKUP/"
          fi
        done
        cd ../..
        
        # Remove old strategies files (but keep the directory and preserved files)
        # Delete only files that are not in the preserve list
        cd rl-training/strategies
        find . -maxdepth 1 -type f | while read -r file; do
          basefile=$(basename "$file")
          if ! echo "$PRESERVE_FILES" | tr ' ' '\n' | grep -xq "$basefile"; then
            echo "Deleting file: $basefile"
            rm -f "$basefile"
          fi
        done
        
        # Restore preserved files
        if [ -n "$(ls -A "$TEMP_BACKUP" 2>/dev/null)" ]; then
          echo "Restoring preserved files:"
          cp "$TEMP_BACKUP/"* rl-training/strategies/ 2>/dev/null || true
          ls -la "$TEMP_BACKUP/"
        fi
        
        # Clean up temporary backup directory
        rm -rf "$TEMP_BACKUP"
        
        # Copy all files from strategies folder, excluding src/ and __pycache__/
        cd algorithm-poc/strategies
        find . -maxdepth 1 -type f \( -name "*.py" -o -name "*.json" -o -name "*.md" \) -exec cp "{}" ../../rl-training/strategies/ \;
        
        # List what was copied
        echo "Files synced to rl-training/strategies:"
        ls -la ../../rl-training/strategies/
    
    - name: Commit and push changes
      working-directory: rl-training
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        git add strategies/
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Sync strategies from algorithm-POC

          Auto-synced strategy files from algorithm-POC repository
          Triggered by commit: ${{ github.sha }}"
          git push
          echo "Changes pushed successfully"
        fi

